Quick start guide
-----------------

First time set-up
`````````````````

.. note::

    This section assumes that **tomato** has been successfully :ref:`installed<installation>`.

To prepare **tomato** for its first execution, you need to supply additional 
information configuring the package. The easiest way to do this is to execute
**tomato** in verbose mode:

.. code::
    
    PS C:\Users\krpe> tomato -vv
    DEBUG:tomato.main:loglevel set to 'DEBUG'
    DEBUG:tomato.setlib.functions:local config folder is 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1'
    DEBUG:tomato.setlib.functions:local data folder is 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1'
    DEBUG:tomato.setlib.functions:local log folder is 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\Logs'
    WARNING:tomato.setlib.functions:config file not present. Writing defaults to 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\settings.toml'
    DEBUG:tomato.setlib.functions:loading tomato settings from 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\settings.toml'
    DEBUG:tomato.setlib.functions:loading pipeline settings from 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\devices.yml'
    ERROR:tomato.setlib.functions:device settings not found. Running with a 'dummy' device.
    DEBUG:tomato.main:setting up 'queue' table in 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\database.db'
    DEBUG:tomato.dbhandler.sqlite:attempting to find table 'queue' in 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\database.db'
    WARNING:tomato.dbhandler.sqlite:creating a new sqlite3 'queue' table at 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\database.db'
    DEBUG:tomato.main:setting up 'state' table in 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\database.db'
    DEBUG:tomato.dbhandler.sqlite:attempting to find table 'state' in 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\database.db'
    WARNING:tomato.dbhandler.sqlite:creating a new sqlite3 'state' table at 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.2a1\database.db'
    DEBUG:tomato.main:checking presence of pipeline 'dummy-5' in 'state'
    INFO:tomato.dbhandler.sqlite:creating pipeline 'dummy-5' in 'state'
    DEBUG:tomato.main:checking presence of pipeline 'dummy-10' in 'state'
    INFO:tomato.dbhandler.sqlite:creating pipeline 'dummy-10' in 'state'

As you see in this verbose output, **tomato** is configured to store its local data in a 
user-accessible folder:

  - ``$env:localappdata\dgbowl\tomato\<version>`` on Windows,
  - ``$HOME/.local/share/tomato/<version>`` on Linux.

Within this ``local config folder``, **tomato** expects to find at least the ``settings.toml`` 
file. As you can also see from the log, by default the ``local data folder`` is also set to the
same path, therefore all of **tomato's** information (*device* settings, *state* and *queue* tables, 
*job* data) will be located in this versioned folder.

.. _setfile:

Settings file
`````````````
The ``settings.toml`` file should be located in the ``local config folder``. The default
generated file looks similar to the below file:

.. code::

    [state]
    type = 'sqlite3'
    path = 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.1rc11\database.db'

    [queue]
    type = 'sqlite3'
    path = 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.1rc11\database.db'
    storage = 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.1rc11\Jobs'

    [devices]
    path = 'C:\Users\krpe\AppData\Local\dgbowl\tomato\0.1rc11\devices.yml'

    [drivers]
    [drivers.biologic]
    dllpath = 'C:\EC-Lab Development Package\EC-Lab Development Package'

In this ``toml``-formatted file, the database ``path`` and ``type`` of the *state* 
and *queue* tables are provided. Additionally, the ``storage`` folder of the raw 
data generated by *jobs* is also defined.

.. note::

    As of ``tomato-0.2a1``, only ``sqlite3`` is supported as a database backend.

The ``settings.toml`` file should also point to a ``yaml``-formatted file defining
the hardware configuration of the devices managed by **tomato**, as well as any
additional *driver*-specific settings (such as the ``dllpath`` required by the 
:mod:`~tomato.drivers.biologic` driver).

.. _devfile:

Devices file
````````````
This ``yaml``-formatted *devices* file contains information about each *device*,
corresponding to an individual piece of hardware managed by **tomato**, as well as 
the organisation of such *devices* into addressable chunks, called *pipelines*:

``devices`` section
*******************

.. code::

    devices:
      - name: MPG2-8
        address: "192.109.209.8"
        channels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
        driver: "biologic"
        pollrate: 60
        capabilities: 
          - open_circuit_voltage
          - constant_current
          - constant_voltage
          - sweep_current
          - sweep_voltage
          - loop

In the example ``devices`` section above, we define a single BioLogic MPG2 potentiostat.
Each entry in this section has to define the ``name`` of the instrument, the ``address`` 
and ``channels`` available and used for connecting to the instrument, the ``driver`` with 
which **tomato** will manage this *device*, the ``pollrate`` specifying the polling frequency 
with which the **tomato** daemon queries the worker job for data, and finally a :class:`list` 
of the ``capabilities`` this *device* supports.

.. note::

    The ``pollrate`` here is an internal setting for **tomato** and defaults to 10 s. It
    is the frequency with which the *job* daemon supervising the *device* asks the *driver*
    for new data, **not** the frequency with which the *driver* asks the hardware for data!

``pipelines`` section
*********************

.. code::

    pipelines:
      - name: MPG2-7-10
        devices:
          - tag: MPG2
            name: MPG2-7
            channel: 10
      - name: MPG2-8-*
        devices:
          - tag: MPG2
            name: MPG2-8
            channel: each

In the example ``pipelines`` section above, we show two ways of defining *pipelines* in
**tomato**. In the first entry, we define a *pipeline* by its ``name``, and assign a 
:class:`list` of *devices* into it, identified within the *pipeline* by their ``tag``,
and matched against the ``devices`` section using the ``name`` and ``channel``.

Alternatively, for multi-channel *devices*, such as the MPG2-8 defined in the example
above, a shorthand for defining a *pipeline* for each ``channel`` is shown in the second
entry.

Multiple *devices* can be combined into a single *pipeline* using the above syntax.
